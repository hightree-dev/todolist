<html>
  <body>
    <h1>To Do List</h1>
    <input/>
    <button>Add</button>
    <ul></ul>
  </body>
  <script>
    const button = document.querySelector('button');
    const input = document.querySelector('input');
    const ul = document.querySelector('ul');
    
    ul.createItem = function(todo) {
      const li = document.createElement('li');
      
      const content = document.createElement('span');
      content.innerText = todo.content;

      const deleteButton = document.createElement('button');
      deleteButton.innerText = 'delete';
      deleteButton.onclick = function(e) {
        let store = db.transaction('todos', 'readwrite').objectStore('todos');
        let deleteReq = store.delete(todo.id);
        deleteReq.addEventListener('success', function(e) {
          li.remove();
        })
      }
      
      li.appendChild(content);
      li.appendChild(deleteButton);
      this.appendChild(li);
    }

    button.onclick = function(e) {
      const content = input.value;
      if (content === '')
        return alert('Please fill in!');
      let store = db.transaction('todos', 'readwrite').objectStore('todos');
      let addReq = store.add({ content });
      addReq.addEventListener('success', function(e) {
          input.value = '';
          ul.createItem({id: ++curId, content });
      });
    }

    let curId = null;
    let db = null;
    const dbReq = indexedDB.open('db', 1);
    dbReq.addEventListener('success', function(e) {
      db = e.target.result;
      let store = db.transaction('todos', 'readonly').objectStore('todos');
      let getAllReq = store.getAll();
      getAllReq.addEventListener('success', function(e) {
        const todos = e.target.result;
        todos.forEach(function(todo){
          ul.createItem(todo);
        });
        curId = todos[todos.length - 1].id;
      });
    });
    dbReq.addEventListener('error', function(e) {
      const error = e.target.error;
      console.log('error', error.name);
    });
    dbReq.addEventListener('upgradeneeded', function(e) {
      db = e.target.result;
      let oldVersion = e.oldVersion;
      if (oldVersion < 1) {
        db.createObjectStore('todos', { keyPath: 'id', autoIncrement: true });
      }
    });
  </script>
</html>